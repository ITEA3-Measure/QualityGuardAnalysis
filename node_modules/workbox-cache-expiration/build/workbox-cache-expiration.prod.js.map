{"version":3,"names":[],"mappings":"","sources":["packages/workbox-cache-expiration/browser.mjs"],"sourcesContent":["this.workbox=this.workbox||{},this.workbox.expiration=function(e,t,r,n){\"use strict\";try{self.workbox.v[\"workbox:cache-expiration:3.0.0-alpha.5\"]=1}catch(e){}const i=\"url\",s=\"timestamp\";class a{constructor(e){this.e=e,this.t=e,this.r=new r.DBWrapper(\"workbox-cache-expiration\",1,{onupgradeneeded:e=>e.target.result.createObjectStore(this.t,{keyPath:i}).createIndex(s,s,{unique:!1})})}setTimestamp(e,t){var r=this;return babelHelpers.asyncToGenerator(function*(){yield r.r.put(r.t,{[i]:new URL(e,location).href,[s]:t})})()}getAllTimestamps(){var e=this;return babelHelpers.asyncToGenerator(function*(){return yield e.r.getAllMatching(e.t,{index:s})})()}getTimestamp(e){var t=this;return babelHelpers.asyncToGenerator(function*(){return(yield t.r.get(t.t,e)).timestamp})()}deleteUrl(e){var t=this;return babelHelpers.asyncToGenerator(function*(){yield t.r.delete(t.t,new URL(e,location).href)})()}}class o{constructor(e,t={}){this.n=!1,this.i=!1,this.s=t.maxEntries,this.a=t.maxAgeSeconds,this.e=e,this.o=new a(e)}expireEntries(){var e=this;return babelHelpers.asyncToGenerator(function*(){if(e.n)return void(e.i=!0);e.n=!0;const t=Date.now(),r=yield e.l(t),n=yield e.c(),i=[...new Set(r.concat(n))];yield Promise.all([e.u(i),e.h(i)]),e.n=!1,e.i&&(e.i=!1,e.expireEntries())})()}l(e){var t=this;return babelHelpers.asyncToGenerator(function*(){if(!t.a)return[];const r=e-1e3*t.a,n=[];return(yield t.o.getAllTimestamps()).forEach(function(e){e.timestamp<r&&n.push(e.url)}),n})()}c(){var e=this;return babelHelpers.asyncToGenerator(function*(){const t=[];if(!e.s)return[];const r=yield e.o.getAllTimestamps();for(;r.length>e.s;){const e=r.shift();t.push(e.url)}return t})()}u(e){var t=this;return babelHelpers.asyncToGenerator(function*(){const r=yield caches.open(t.e);for(const t of e)yield r.delete(t)})()}h(e){var t=this;return babelHelpers.asyncToGenerator(function*(){for(const r of e)yield t.o.deleteUrl(r)})()}updateTimestamp(e){var t=this;return babelHelpers.asyncToGenerator(function*(){const r=new URL(e,location);r.hash=\"\",yield t.o.setTimestamp(r.href,Date.now())})()}isURLExpired(e){var r=this;return babelHelpers.asyncToGenerator(function*(){if(!r.a)throw new t.WorkboxError(\"expired-test-without-max-age\",{methodName:\"isURLExpired\",paramName:\"maxAgeSeconds\"});const n=new URL(e,location);n.hash=\"\";return(yield r.o.getTimestamp(n.href))<Date.now()-1e3*r.a})()}}return e.CacheExpiration=o,e.Plugin=class{constructor(e={}){this.d=e,this.a=e.maxAgeSeconds,this.p=new Map}f(e){if(e===n.cacheNames.getRuntimeName())throw new t.WorkboxError(\"expire-custom-caches-only\");let r=this.p.get(e);return r||(r=new o(e,this.d),this.p.set(e,r)),r}cachedResponseWillBeUsed({cacheName:e,cachedResponse:t}){if(!t)return null;let r=this.b(t);const n=this.f(e);return n.expireEntries(),r?t:null}b(e){if(!this.a)return!0;const t=this.m(e);if(null===t)return!0;const r=Date.now();return t>=r-1e3*this.a}m(e){const t=e.headers.get(\"date\"),r=new Date(t),n=r.getTime();return isNaN(n)?null:n}cacheDidUpdate({cacheName:e,request:t}){var r=this;return babelHelpers.asyncToGenerator(function*(){const n=r.f(e);yield n.updateTimestamp(t.url),yield n.expireEntries()})()}},e}({},workbox.core._private,workbox.core._private,workbox.core._private);\n"],"file":"workbox-cache-expiration.prod.js"}